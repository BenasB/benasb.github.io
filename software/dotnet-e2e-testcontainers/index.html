<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta content="IE=edge" http-equiv="X-UA-Compatible"><meta content="width=device-width,initial-scale=1" name="viewport"><title>.NET end-to-end testing using Testcontainers | Bx2 Blog</title><link href="/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180"><link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"><link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"><link href="/site.webmanifest" rel="manifest"><link href="/safari-pinned-tab.svg" rel="mask-icon" color="#5bbad5"><meta content="#da532c" name="msapplication-TileColor"><meta content="#ffffff" name="theme-color"><script defer src="/bundle.js"></script><link href="/main.4b268f310c8266768b4b.css" rel="stylesheet"><link href="https://fonts.googleapis.com" rel="preconnect"><meta content="Using Testcontainers for .NET to spin up applications for end-to-end testing" data-react-helmet="true" name="description"><meta content=".NET end-to-end testing using Testcontainers | Bx2 Blog" data-react-helmet="true" property="og:title"><meta content="Using Testcontainers for .NET to spin up applications for end-to-end testing" data-react-helmet="true" property="og:description"><meta content="https://benasb.github.io/og/blog/dotnet-e2e-testcontainers.png" data-react-helmet="true" property="og:image"><meta content="summary_large_image" data-react-helmet="true" name="twitter:card"><link href="https://fonts.gstatic.com" rel="preconnect"></head><body><div id="root"><div class="theme--light"><div class="app-module__app___02Hyl"><header class="header-module__container___O5DHA"><div class="header-module__content___fF0K4"><a href="/"><img alt="logo" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTE2IiBoZWlnaHQ9IjQ4IiB2aWV3Qm94PSIwIDAgMTE2IDQ4IiBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8cGF0aCBkPSJNMC4xMiA0OFYwLjgzMTk5N0gyNy4yNTZMMzQuMzYgNy45MzZWMTkuMDA4TDMxLjI4OCAyMi40NjRMMzYuNDcyIDI3LjU4NFY0MC44OTZMMjkuMzY4IDQ4SDAuMTJaTTguMTIgMTkuNzc2SDIzLjU0NEwyNi4yOTYgMTYuNTc2VjEwLjY4OEwyMy40OCA3Ljg3Mkg4LjEyVjE5Ljc3NlpNOC4xMiA0MC45NkgyNS41OTJMMjguNDA4IDM4LjE0NFYyOS42MzJMMjUuNTkyIDI2LjgxNkg4LjEyVjQwLjk2Wk00MC45NTI1IDQ4TDUyLjc5MjUgMzAuOTEyTDQwLjk1MjUgMTQuNTI4SDUwLjIzMjVMNTguOTM2NSAyNy4ySDYwLjQ3MjVMNjkuMTEyNSAxNC41MjhINzguMzkyNUw2Ni42MTY1IDMwLjg0OEw3OC4zOTI1IDQ4SDY4LjkyMDVMNjAuNDA4NSAzNC43NTJINTguODA4NUw1MC40ODg1IDQ4SDQwLjk1MjVaTTgzLjM1MDUgNDhWMzguMjA4TDEwNy40NzkgMTYuNDQ4VjEwLjY4OEwxMDQuNjYzIDcuODcySDkyLjgyMjVMODguMTUwNSAxMi41NDRMODIuOTAyNSA3LjIzMkw4OS4zMDI1IDAuODMxOTk3SDEwOC4zNzVMMTE1LjQ3OSA3LjkzNlYxOS43NzZMOTIuNDM4NSA0MC43MDRIMTE1LjkyN1Y0OEg4My4zNTA1WiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+Cg=="></a><nav class="header-module__navigation___Ri0Ak"><a href="/">Blog</a><a href="/me">Me</a><button class="themeToggle-module__button___yoBaI"><img alt="Sun theme toggle" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pg0KPCEtLSBHZW5lcmF0b3I6IEFkb2JlIElsbHVzdHJhdG9yIDE4LjAuMCwgU1ZHIEV4cG9ydCBQbHVnLUluIC4gU1ZHIFZlcnNpb246IDYuMDAgQnVpbGQgMCkgIC0tPg0KPCFET0NUWVBFIHN2ZyBQVUJMSUMgIi0vL1czQy8vRFREIFNWRyAxLjEvL0VOIiAiaHR0cDovL3d3dy53My5vcmcvR3JhcGhpY3MvU1ZHLzEuMS9EVEQvc3ZnMTEuZHRkIj4NCjxzdmcgdmVyc2lvbj0iMS4xIiBpZD0iQ2FwYV8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCINCgkgdmlld0JveD0iMCAwIDIwOC45NDggMjA4Ljk0OCIgc3R5bGU9ImVuYWJsZS1iYWNrZ3JvdW5kOm5ldyAwIDAgMjA4Ljk0OCAyMDguOTQ4OyIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+DQo8Zz4NCgk8cGF0aCBzdHlsZT0iZmlsbDojMUQxRDFCOyIgZD0iTTEwNC40NzQsMzguMzE3Yy0zNi40NzksMC02Ni4xNTgsMjkuNjc4LTY2LjE1OCw2Ni4xNTdzMjkuNjc4LDY2LjE1Nyw2Ni4xNTgsNjYuMTU3DQoJCXM2Ni4xNTgtMjkuNjc4LDY2LjE1OC02Ni4xNTdTMTQwLjk1NCwzOC4zMTcsMTA0LjQ3NCwzOC4zMTd6IE0xMDQuNDc0LDE1NS42MzJjLTI4LjIwOCwwLTUxLjE1OC0yMi45NDktNTEuMTU4LTUxLjE1Nw0KCQlzMjIuOTQ5LTUxLjE1Nyw1MS4xNTgtNTEuMTU3czUxLjE1OCwyMi45NDksNTEuMTU4LDUxLjE1N1MxMzIuNjgzLDE1NS42MzIsMTA0LjQ3NCwxNTUuNjMyeiIvPg0KCTxwYXRoIHN0eWxlPSJmaWxsOiMxRDFEMUI7IiBkPSJNMTAzLjkyOSwzMi4yMjhjMC4wMTcsMCwwLjAzNSwwLDAuMDUyLDBjNC4xNDItMC4wMjgsNy40NzctMy40MDksNy40NDktNy41NTFMMTExLjMxMyw3LjQ1DQoJCWMtMC4wMjktNC4xNDMtMy40MDItNy41MTYtNy41NTEtNy40NDljLTQuMTQyLDAuMDI4LTcuNDc3LDMuNDA5LTcuNDQ5LDcuNTUxbDAuMTE3LDE3LjIyNw0KCQlDOTYuNDU4LDI4LjkwMyw5OS44MTEsMzIuMjI4LDEwMy45MjksMzIuMjI4eiIvPg0KCTxwYXRoIHN0eWxlPSJmaWxsOiMxRDFEMUI7IiBkPSJNMTYwLjQ3OSw1NS4yYzEuOTM3LDAsMy44NzMtMC43NDUsNS4zNC0yLjIzMmwxMi4wOTgtMTIuMjY0YzIuOTA5LTIuOTQ5LDIuODc2LTcuNjk4LTAuMDcyLTEwLjYwNg0KCQljLTIuOTUtMi45MTEtNy42OTgtMi44NzgtMTAuNjA2LDAuMDcxTDE1NS4xNCw0Mi40MzNjLTIuOTA5LDIuOTQ5LTIuODc2LDcuNjk4LDAuMDcyLDEwLjYwNg0KCQlDMTU2LjY3Myw1NC40ODEsMTU4LjU3Niw1NS4yLDE2MC40NzksNTUuMnoiLz4NCgk8cGF0aCBzdHlsZT0iZmlsbDojMUQxRDFCOyIgZD0iTTIwMS40NDksOTYuMzEzYy0wLjAxNywwLTAuMDM1LDAtMC4wNTIsMGwtMTcuMjI3LDAuMTE3Yy00LjE0MiwwLjAyOC03LjQ3NywzLjQwOS03LjQ0OSw3LjU1MQ0KCQljMC4wMjgsNC4xMjUsMy4zOCw3LjQ0OSw3LjQ5OSw3LjQ0OWMwLjAxNywwLDAuMDM1LDAsMC4wNTIsMGwxNy4yMjctMC4xMTdjNC4xNDItMC4wMjgsNy40NzctMy40MDksNy40NDktNy41NTENCgkJQzIwOC45MTksOTkuNjM4LDIwNS41NjcsOTYuMzEzLDIwMS40NDksOTYuMzEzeiIvPg0KCTxwYXRoIHN0eWxlPSJmaWxsOiMxRDFEMUI7IiBkPSJNMTY2LjUxNSwxNTUuMTQxYy0yLjk0OS0yLjkxMS03LjY5OC0yLjg3OC0xMC42MDYsMC4wNzFjLTIuOTA5LDIuOTQ5LTIuODc2LDcuNjk4LDAuMDcyLDEwLjYwNg0KCQlsMTIuMjY0LDEyLjA5OWMxLjQ2MSwxLjQ0MiwzLjM2NCwyLjE2MSw1LjI2NywyLjE2MWMxLjkzNywwLDMuODczLTAuNzQ1LDUuMzQtMi4yMzJjMi45MDktMi45NDksMi44NzYtNy42OTgtMC4wNzItMTAuNjA2DQoJCUwxNjYuNTE1LDE1NS4xNDF6Ii8+DQoJPHBhdGggc3R5bGU9ImZpbGw6IzFEMUQxQjsiIGQ9Ik0xMDQuOTY3LDE3Ni43MjJjLTQuMTQyLDAuMDI4LTcuNDc3LDMuNDA5LTcuNDQ5LDcuNTUxbDAuMTE3LDE3LjIyNw0KCQljMC4wMjgsNC4xMjUsMy4zOCw3LjQ0OSw3LjQ5OSw3LjQ0OWMwLjAxNywwLDAuMDM1LDAsMC4wNTIsMGM0LjE0Mi0wLjAyOCw3LjQ3Ny0zLjQwOSw3LjQ0OS03LjU1MWwtMC4xMTctMTcuMjI3DQoJCUMxMTIuNDksMTgwLjAyOCwxMDkuMDkzLDE3Ni43MDgsMTA0Ljk2NywxNzYuNzIyeiIvPg0KCTxwYXRoIHN0eWxlPSJmaWxsOiMxRDFEMUI7IiBkPSJNNDMuMTMsMTU1Ljk4MWwtMTIuMDk4LDEyLjI2NGMtMi45MDksMi45NDktMi44NzYsNy42OTgsMC4wNzIsMTAuNjA2DQoJCWMxLjQ2MSwxLjQ0MiwzLjM2NCwyLjE2MSw1LjI2NywyLjE2MWMxLjkzNywwLDMuODczLTAuNzQ1LDUuMzQtMi4yMzJsMTIuMDk4LTEyLjI2NGMyLjkwOS0yLjk0OSwyLjg3Ni03LjY5OC0wLjA3Mi0xMC42MDYNCgkJQzUwLjc4NywxNTIuOTk5LDQ2LjAzOCwxNTMuMDMyLDQzLjEzLDE1NS45ODF6Ii8+DQoJPHBhdGggc3R5bGU9ImZpbGw6IzFEMUQxQjsiIGQ9Ik0zMi4yMjcsMTA0Ljk2OGMtMC4wMjgtNC4xMjUtMy4zOC03LjQ0OS03LjQ5OS03LjQ0OWMtMC4wMTcsMC0wLjAzNSwwLTAuMDUyLDBMNy40NSw5Ny42MzYNCgkJYy00LjE0MiwwLjAyOC03LjQ3NywzLjQwOS03LjQ0OSw3LjU1MWMwLjAyOCw0LjEyNSwzLjM4LDcuNDQ5LDcuNDk5LDcuNDQ5YzAuMDE3LDAsMC4wMzUsMCwwLjA1MiwwbDE3LjIyNy0wLjExNw0KCQlDMjguOTIsMTEyLjQ5LDMyLjI1NSwxMDkuMTA5LDMyLjIyNywxMDQuOTY4eiIvPg0KCTxwYXRoIHN0eWxlPSJmaWxsOiMxRDFEMUI7IiBkPSJNNDIuNDMzLDUzLjgwOWMxLjQ2MSwxLjQ0MiwzLjM2NCwyLjE2MSw1LjI2NywyLjE2MWMxLjkzNywwLDMuODczLTAuNzQ1LDUuMzQtMi4yMzINCgkJYzIuOTA5LTIuOTQ5LDIuODc2LTcuNjk4LTAuMDcyLTEwLjYwNkw0MC43MDMsMzEuMDMyYy0yLjk0OS0yLjkxMi03LjY5OC0yLjg3Ny0xMC42MDYsMC4wNzENCgkJYy0yLjkwOSwyLjk0OS0yLjg3Niw3LjY5OCwwLjA3MiwxMC42MDZMNDIuNDMzLDUzLjgwOXoiLz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjxnPg0KPC9nPg0KPGc+DQo8L2c+DQo8Zz4NCjwvZz4NCjwvc3ZnPg0K" class="themeToggle-module__image___Wonv0"></button></nav></div></header><div class="contentLayout-module__wrapper___oHArs"><article><div class="postHeader-module__header___tSRj5"><div class="postHeader-module__topRow___skaIE"><a href="/software" class="postHeader-module__topic___4ffvm"><img alt="left arrow" src="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iaXNvLTg4NTktMSI/Pgo8IS0tIEdlbmVyYXRvcjogQWRvYmUgSWxsdXN0cmF0b3IgMTkuMC4wLCBTVkcgRXhwb3J0IFBsdWctSW4gLiBTVkcgVmVyc2lvbjogNi4wMCBCdWlsZCAwKSAgLS0+CjxzdmcgdmVyc2lvbj0iMS4xIiBpZD0iQ2FwYV8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCIKCSB2aWV3Qm94PSIwIDAgNDQzLjUyIDQ0My41MiIgc3R5bGU9ImVuYWJsZS1iYWNrZ3JvdW5kOm5ldyAwIDAgNDQzLjUyIDQ0My41MjsiIHhtbDpzcGFjZT0icHJlc2VydmUiPgo8Zz4KCTxnPgoJCTxwYXRoIGQ9Ik0xNDMuNDkyLDIyMS44NjNMMzM2LjIyNiwyOS4xMjljNi42NjMtNi42NjQsNi42NjMtMTcuNDY4LDAtMjQuMTMyYy02LjY2NS02LjY2Mi0xNy40NjgtNi42NjItMjQuMTMyLDBsLTIwNC44LDIwNC44CgkJCWMtNi42NjIsNi42NjQtNi42NjIsMTcuNDY4LDAsMjQuMTMybDIwNC44LDIwNC44YzYuNzgsNi41NDgsMTcuNTg0LDYuMzYsMjQuMTMyLTAuNDJjNi4zODctNi42MTQsNi4zODctMTcuMDk5LDAtMjMuNzEyCgkJCUwxNDMuNDkyLDIyMS44NjN6Ii8+Cgk8L2c+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPGc+CjwvZz4KPC9zdmc+Cg==" height="15" width="15"><h3>Software</h3></a><h3 class="postHeader-module__date___mWm7I">2023-08-13</h3></div><h1>.NET end-to-end testing using Testcontainers</h1></div><div class="post-module__content___Rvpqj"><a href="#what-are-we-trying-to-achieve?" class="postSectionHeader-module__link___iC7QI"><img alt="Go to what-are-we-trying-to-achieve?" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBhcmlhLWhpZGRlbj0idHJ1ZSIgcm9sZT0iaW1nIiB3aWR0aD0iMWVtIiBoZWlnaHQ9IjFlbSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ieE1pZFlNaWQgbWVldCIgdmlld0JveD0iMCAwIDI0IDI0Ij48ZyBmaWxsPSJub25lIj48cGF0aCBkPSJNMTMuNTQ0IDEwLjQ1NmE0LjM2OCA0LjM2OCAwIDAgMC02LjE3NiAwbC0zLjA4OSAzLjA4OGE0LjM2NyA0LjM2NyAwIDEgMCA2LjE3NyA2LjE3N0wxMiAxOC4xNzciIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjxwYXRoIGQ9Ik0xMC40NTYgMTMuNTQ0YTQuMzY4IDQuMzY4IDAgMCAwIDYuMTc2IDBsMy4wODktMy4wODhhNC4zNjcgNC4zNjcgMCAxIDAtNi4xNzctNi4xNzdMMTIgNS44MjMiIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjwvZz48L3N2Zz4=" class="postSectionHeader-module__icon___jd0Dl" style="top:10px"><h2 id="what-are-we-trying-to-achieve?">What are we trying to achieve?</h2></a><p class="post-module__p___-9FAs">Create automated tests for applications composed of multiple .NET services and infrastructure components that verify some flow through the whole application. The resulting tests should be repeatable, isolated and not require any pre-provisioned infrastructure.</p><p class="post-module__p___-9FAs">Apart from general .NET and xUnit knowledge this post also assumes that the reader has some basic Docker knowledge.</p><a href="#what-is-testcontainers?" class="postSectionHeader-module__link___iC7QI"><img alt="Go to what-is-testcontainers?" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBhcmlhLWhpZGRlbj0idHJ1ZSIgcm9sZT0iaW1nIiB3aWR0aD0iMWVtIiBoZWlnaHQ9IjFlbSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ieE1pZFlNaWQgbWVldCIgdmlld0JveD0iMCAwIDI0IDI0Ij48ZyBmaWxsPSJub25lIj48cGF0aCBkPSJNMTMuNTQ0IDEwLjQ1NmE0LjM2OCA0LjM2OCAwIDAgMC02LjE3NiAwbC0zLjA4OSAzLjA4OGE0LjM2NyA0LjM2NyAwIDEgMCA2LjE3NyA2LjE3N0wxMiAxOC4xNzciIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjxwYXRoIGQ9Ik0xMC40NTYgMTMuNTQ0YTQuMzY4IDQuMzY4IDAgMCAwIDYuMTc2IDBsMy4wODktMy4wODhhNC4zNjcgNC4zNjcgMCAxIDAtNi4xNzctNi4xNzdMMTIgNS44MjMiIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjwvZz48L3N2Zz4=" class="postSectionHeader-module__icon___jd0Dl" style="top:10px"><h2 id="what-is-testcontainers?">What is Testcontainers?</h2></a><p class="post-module__p___-9FAs">In short, Testcontainers is a library which allows you to spin up throwaway containers on a Docker host and use them (primarily) for testing. Containers give us a lot of options to choose from: we can spin up existing widely used images (e.g. Postgres, Redis) or create images of our own applications. Essentially, using Testcontainers your test code <em>orchestrates</em> the containers (tells the Docker host when and how to start containers, when to terminate them, etc.).</p><p class="post-module__p___-9FAs">Despite this blog post being focused on .NET, Testcontainers is <a href="https://testcontainers.com/getting-started/#supported-languages-and-prerequisites" class="post-module__link___nNizU" rel="noopener noreferrer" target="_blank">supported by other languages</a> as well, so the general idea can be carried through to other languages.</p><p class="post-module__p___-9FAs">Testcontainers for .NET also provides us with modules, which are pre-configurations of popular Docker images. We'll be using them in Example 2.</p><p class="post-module__p___-9FAs">For a more thorough explanation of Testcontainers, I'd like to forward you to the official "<a href="https://testcontainers.com/getting-started/" class="post-module__link___nNizU" rel="noopener noreferrer" target="_blank">Getting started</a>" page.</p><p class="post-module__p___-9FAs">Also check out the <a href="https://dotnet.testcontainers.org/" class="post-module__link___nNizU" rel="noopener noreferrer" target="_blank">Testcontainers for .NET</a> page. The .NET library is heavily maintained and being improved. Props to <a href="https://github.com/HofmeisterAn" class="post-module__link___nNizU" rel="noopener noreferrer" target="_blank">HofmeisterAn</a> and maintainers!</p><a href="#example-1" class="postSectionHeader-module__link___iC7QI"><img alt="Go to example-1" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBhcmlhLWhpZGRlbj0idHJ1ZSIgcm9sZT0iaW1nIiB3aWR0aD0iMWVtIiBoZWlnaHQ9IjFlbSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ieE1pZFlNaWQgbWVldCIgdmlld0JveD0iMCAwIDI0IDI0Ij48ZyBmaWxsPSJub25lIj48cGF0aCBkPSJNMTMuNTQ0IDEwLjQ1NmE0LjM2OCA0LjM2OCAwIDAgMC02LjE3NiAwbC0zLjA4OSAzLjA4OGE0LjM2NyA0LjM2NyAwIDEgMCA2LjE3NyA2LjE3N0wxMiAxOC4xNzciIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjxwYXRoIGQ9Ik0xMC40NTYgMTMuNTQ0YTQuMzY4IDQuMzY4IDAgMCAwIDYuMTc2IDBsMy4wODktMy4wODhhNC4zNjcgNC4zNjcgMCAxIDAtNi4xNzctNi4xNzdMMTIgNS44MjMiIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjwvZz48L3N2Zz4=" class="postSectionHeader-module__icon___jd0Dl" style="top:10px"><h2 id="example-1">Example 1</h2></a><p class="post-module__p___-9FAs"><em>The source code for this can be found on <a href="https://github.com/BenasB/dotnet-e2e-testcontainers/tree/main/ExampleOne" class="post-module__link___nNizU" rel="noopener noreferrer" target="_blank">GitHub</a></em></p><p class="post-module__p___-9FAs">Let's start off with a super simple scenario. We have two REST APIs: Calculator and History. Calculator supports two actions: <code class="post-module__code___aFlPv">/add</code> and <code class="post-module__code___aFlPv">/subtract</code> which do what you expect – return you the result of the corresponding operation after you give it the operands. Upon sending the request to Calculator, it also sends the result to the History API which saves (in memory) what actions were performed and their results. The data flow diagram can be seen below.</p><p class="post-module__p___-9FAs"><span class="lazy-load-image-background blur" style="width:100%"><span class="" style="display:block;margin:0 auto;max-width:100%"></span></span></p><p class="post-module__p___-9FAs">This small application only has 2 .NET services but that is enough to explain the basic principles. The application flow that we want to test is:</p><ol class="post-module__list___kIKQ1"><li class="post-module__li___TFeQu">Perform <code class="post-module__code___aFlPv">/add</code> on the Calculator</li><li class="post-module__li___TFeQu">Perform <code class="post-module__code___aFlPv">/subtract</code> on the Calculator</li><li class="post-module__li___TFeQu">Ensure that History saved the operations and they are in the order they were performed</li></ol><p class="post-module__p___-9FAs">To write a test for this, we will need to spin up both the Calculator and History APIs. Of course, these services need to be containerized, so both of them should have Dockerfiles (creating them is straightforward, but out of scope of this post).</p><p class="post-module__p___-9FAs">Before getting into the Testcontainers code, let's take a small detour and talk briefly about Docker networking:</p><ol class="post-module__list___kIKQ1"><li class="post-module__li___TFeQu">By default, processes from the host machine <strong>can't</strong> access containers. You have to explicitly expose (also referred to as binding or mapping) ports when creating the container (this is visualized as the circle below). Exposing a port of course requires two ports: the host machine port (<code class="post-module__code___aFlPv">8888</code> in the diagram) which can be an arbitrary port number and the Docker container port (<code class="post-module__code___aFlPv">80</code> in the diagram). In the diagram below, if the container was for example a web server listening on port <code class="post-module__code___aFlPv">80</code> it could be accessed from the host machine by requesting <code class="post-module__code___aFlPv">http://localhost:8888</code>. This is discussed in "<a href="https://docs.docker.com/network/#published-ports" class="post-module__link___nNizU" rel="noopener noreferrer" target="_blank">Published ports</a>".<div style="margin:20px 0"><span class="lazy-load-image-background blur" style="width:100%"><span class="" style="display:block;margin:0 auto;max-width:100%"></span></span></div></li><li class="post-module__li___TFeQu">By default, containers on the same Docker (bridge) network <strong>can</strong> access each other. On a (user defined bridge) Docker network (which we'll be creating during our tests) containers can reach each other using IP, hostname or network alias. You don't need to expose any ports for other containers to reach them. We'll be using network aliases for container-to-container communication. In the diagram below, if Container 2 was for example a web server listening on port <code class="post-module__code___aFlPv">80</code> then Container 1 could access it by requesting <code class="post-module__code___aFlPv">http://ben:80</code>. This is discussed in "<a href="https://docs.docker.com/network/drivers/bridge/#differences-between-user-defined-bridges-and-the-default-bridge" class="post-module__link___nNizU" rel="noopener noreferrer" target="_blank">Bridge</a>".<div style="margin:20px 0"><span class="lazy-load-image-background blur" style="width:100%"><span class="" style="display:block;margin:0 auto;max-width:100%"></span></span></div></li></ol><p class="post-module__p___-9FAs">With that knowledge, we can visualize how our test should look like from a network perspective. For the port bindings, we can make our .NET services listen on port 80 (that's already the default when using <code class="post-module__code___aFlPv">mcr.microsoft.com/dotnet/aspnet</code> base image) and the machine host ports don't really matter so let's assume they're just some port numbers <code class="post-module__code___aFlPv">X</code> and <code class="post-module__code___aFlPv">Y</code> (Testcontainers will assign them for us). Calculator will be calling History through the Docker network via an alias (e.g. <code class="post-module__code___aFlPv">http://history:80</code>). You might be wondering why we need the port binding with History – for the application flow step 3 we will want to request data from the History API to compare it with what the test process passed into Calculator (this will be our assertion).</p><p class="post-module__p___-9FAs"><span class="lazy-load-image-background blur" style="width:100%"><span class="" style="display:block;margin:0 auto;max-width:100%"></span></span></p><p class="post-module__p___-9FAs">Finally, let's get to the code! xUnit provides us a way to share context between tests using so-called <a href="https://xunit.net/docs/shared-context" class="post-module__link___nNizU" rel="noopener noreferrer" target="_blank">fixtures</a> – that's what we want. We'll create an <code class="post-module__code___aFlPv">AppFixture</code> class which will be responsible for the whole lifetime of the containers. At first, it might seem like a lot of code, but it's doing a lot as well, so let's tackle it one by one.</p><pre class="prism-code language-csharp" style="color:#9cdcfe;background-color:#1e1e1e;padding:20px;border-radius:5px;overflow:auto"><div class="token-line" style="color:#9cdcfe"><span class="token keyword" style="color:#569cd6">using</span><span class="token plain"> </span><span class="token namespace">DotNet</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Testcontainers</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Builders</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">using</span><span class="token plain"> </span><span class="token namespace">DotNet</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Testcontainers</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Containers</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">using</span><span class="token plain"> </span><span class="token namespace">DotNet</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Testcontainers</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Images</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">using</span><span class="token plain"> </span><span class="token namespace">DotNet</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Testcontainers</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Networks</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">namespace</span><span class="token plain"> </span><span class="token namespace">EndToEndTests</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">class</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">AppFixture</span><span class="token plain"> </span><span class="token punctuation" style="color:#d4d4d4">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:#4ec9b0">IAsyncLifetime</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token comment" style="color:#6a9955">// This network will contain the Calculator and History containers</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">INetwork</span><span class="token plain"> _network</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token comment" style="color:#6a9955">// Creating an image from a Dockerfile can be skipped if you are using an already pre built image</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">IFutureDockerImage</span><span class="token plain"> _calculatorImage</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">IFutureDockerImage</span><span class="token plain"> _historyImage</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">IContainer</span><span class="token plain"> _calculatorContainer</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">IContainer</span><span class="token plain"> _historyContainer</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token comment" style="color:#6a9955">// Clients are used by tests to input data and assert results</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">HttpClient</span><span class="token class-name punctuation" style="color:#d4d4d4">?</span><span class="token plain"> _calculatorClient</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">HttpClient</span><span class="token class-name punctuation" style="color:#d4d4d4">?</span><span class="token plain"> _historyClient</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#4ec9b0">HttpClient</span><span class="token plain"> CalculatorClient </span><span class="token operator" style="color:#d4d4d4">=></span><span class="token plain"> _calculatorClient </span><span class="token operator" style="color:#d4d4d4">??</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">InvalidOperationException</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"Calculator client was not initialized"</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#4ec9b0">HttpClient</span><span class="token plain"> HistoryClient </span><span class="token operator" style="color:#d4d4d4">=></span><span class="token plain"> _historyClient </span><span class="token operator" style="color:#d4d4d4">??</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">InvalidOperationException</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"History client was not initialized"</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token function" style="color:#dcdcaa">AppFixture</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _network </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">NetworkBuilder</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">          </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">Build</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _historyImage </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">ImageFromDockerfileBuilder</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithDockerfileDirectory</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">CommonDirectoryPath</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">GetSolutionDirectory</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"> </span><span class="token string" style="color:#ce9178">"History"</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token comment" style="color:#6a9955">// Used to clean up multi-stage intermediate layers</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithBuildArgument</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"RESOURCE_REAPER_SESSION_ID"</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"> ResourceReaper</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">DefaultSessionId</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">ToString</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"D"</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">Build</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _calculatorImage </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">ImageFromDockerfileBuilder</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithDockerfileDirectory</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">CommonDirectoryPath</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">GetSolutionDirectory</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"> </span><span class="token string" style="color:#ce9178">"Calculator"</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithBuildArgument</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"RESOURCE_REAPER_SESSION_ID"</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"> ResourceReaper</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">DefaultSessionId</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">ToString</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"D"</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">Build</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _historyContainer </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">ContainerBuilder</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithImage</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">_historyImage</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token comment" style="color:#6a9955">// Port binding required to allow connection from outside the docker network</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token comment" style="color:#6a9955">// e.g. our test process needs to access this</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithPortBinding</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token number" style="color:#b5cea8">80</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithNetwork</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">_network</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithNetworkAliases</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token keyword" style="color:#569cd6">nameof</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">_historyContainer</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithWaitStrategy</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">Wait</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">ForUnixContainer</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">UntilPortIsAvailable</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token number" style="color:#b5cea8">80</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">Build</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _calculatorContainer </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">ContainerBuilder</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithImage</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">_calculatorImage</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithPortBinding</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token number" style="color:#b5cea8">80</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithNetwork</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">_network</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithNetworkAliases</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token keyword" style="color:#569cd6">nameof</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">_calculatorContainer</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithWaitStrategy</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">Wait</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">ForUnixContainer</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">UntilPortIsAvailable</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token number" style="color:#b5cea8">80</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token comment" style="color:#6a9955">// Let Calculator know how to call History by using the docker network</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token comment" style="color:#6a9955">// The history container is not started at this time but we know the hostname</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token comment" style="color:#6a9955">// beforehand due to setting it with WithNetworkAliases on _historyContainer.</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithEnvironment</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"HistoryBaseAddress"</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"> </span><span class="token interpolation-string string" style="color:#ce9178">$"http://</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:#569cd6">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:#d4d4d4">(</span><span class="token interpolation-string interpolation expression language-csharp">_historyContainer</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:#d4d4d4">)</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">}</span><span class="token interpolation-string string" style="color:#ce9178">:80"</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">Build</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#4ec9b0">Task</span><span class="token plain"> </span><span class="token function" style="color:#dcdcaa">DisposeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token class-name keyword" style="color:#569cd6">var</span><span class="token plain"> calculatorDisposal </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> _calculatorContainer</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">DisposeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token class-name keyword" style="color:#569cd6">var</span><span class="token plain"> historyDisposal </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> _historyContainer</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">DisposeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> calculatorDisposal</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> historyDisposal</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _network</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">DisposeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#4ec9b0">Task</span><span class="token plain"> </span><span class="token function" style="color:#dcdcaa">InitializeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _network</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">CreateAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token comment" style="color:#6a9955">// We can start both of the containers in parallel</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token comment" style="color:#6a9955">// However, this might not work if some dependency must be resolved at start up</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token comment" style="color:#6a9955">// In our case, Calculator depends on History but uses it only when processing requests and not on startup</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> Task</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WhenAll</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            Task</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">Run</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token keyword" style="color:#569cd6">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"> </span><span class="token operator" style="color:#d4d4d4">=></span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">                </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _historyImage</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">CreateAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">                </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _historyContainer</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">StartAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">}</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            Task</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">Run</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token keyword" style="color:#569cd6">async</span><span class="token plain"> </span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"> </span><span class="token operator" style="color:#d4d4d4">=></span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">                </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _calculatorImage</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">CreateAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">                </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _calculatorContainer</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">StartAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">}</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _historyClient </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">HttpClient</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token comment" style="color:#6a9955">// Use _container.Hostname which will resolve to 127.0.0.1 because</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token comment" style="color:#6a9955">// we want to connect from the test process (outside of docker network)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            BaseAddress </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">Uri</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token interpolation-string string" style="color:#ce9178">$"http://</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">{</span><span class="token interpolation-string interpolation expression language-csharp">_historyContainer</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:#d4d4d4">.</span><span class="token interpolation-string interpolation expression language-csharp">Hostname</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">}</span><span class="token interpolation-string string" style="color:#ce9178">:</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">{</span><span class="token interpolation-string interpolation expression language-csharp">_historyContainer</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:#d4d4d4">.</span><span class="token interpolation-string interpolation expression language-csharp function" style="color:#dcdcaa">GetMappedPublicPort</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:#d4d4d4">(</span><span class="token interpolation-string interpolation expression language-csharp number" style="color:#b5cea8">80</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:#d4d4d4">)</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">}</span><span class="token interpolation-string string" style="color:#ce9178">"</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token punctuation" style="color:#d4d4d4">}</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _calculatorClient </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">HttpClient</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            BaseAddress </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">Uri</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token interpolation-string string" style="color:#ce9178">$"http://</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">{</span><span class="token interpolation-string interpolation expression language-csharp">_calculatorContainer</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:#d4d4d4">.</span><span class="token interpolation-string interpolation expression language-csharp">Hostname</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">}</span><span class="token interpolation-string string" style="color:#ce9178">:</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">{</span><span class="token interpolation-string interpolation expression language-csharp">_calculatorContainer</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:#d4d4d4">.</span><span class="token interpolation-string interpolation expression language-csharp function" style="color:#dcdcaa">GetMappedPublicPort</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:#d4d4d4">(</span><span class="token interpolation-string interpolation expression language-csharp number" style="color:#b5cea8">80</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:#d4d4d4">)</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">}</span><span class="token interpolation-string string" style="color:#ce9178">"</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token punctuation" style="color:#d4d4d4">}</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token punctuation" style="color:#d4d4d4">}</span></div></pre><ol class="post-module__list___kIKQ1"><li class="post-module__li___TFeQu"><code class="post-module__code___aFlPv">AppFixture</code> inherits <code class="post-module__code___aFlPv">IAsyncLifetime</code>. xUnit will handle calling <code class="post-module__code___aFlPv">InitializeAsync</code> and <code class="post-module__code___aFlPv">DisposeAsync</code> for us.</li><li class="post-module__li___TFeQu">We can see that <code class="post-module__code___aFlPv">INetwork</code> is created. This is the "User defined bridge network" we talked about.</li><li class="post-module__li___TFeQu">Two <code class="post-module__code___aFlPv">IFutureDockerImage</code>s are created. These represent the Docker images to be built from our two .NET services.</li><li class="post-module__li___TFeQu">Two <code class="post-module__code___aFlPv">IContainer</code>s are created. Take a good look at their configuration. We specify the network to connect them to, the network alias, the port mappings and also for the Calculator container we specify how to communicate with the History API by passing in <code class="post-module__code___aFlPv">HistoryBaseAddress</code> using its network alias.</li><li class="post-module__li___TFeQu">In the constructor, we configure and build the builders. In <code class="post-module__code___aFlPv">InitializeAsync</code> we actually create the Docker network, build images and start containers and in <code class="post-module__code___aFlPv">DisposeAsync</code> we stop/clean up the containers.</li><li class="post-module__li___TFeQu">Two <code class="post-module__code___aFlPv">HttpClient</code>s are created. These will be used by our test to send requests to the containers. Note how they are configured. They require the port mappings on the containers since the clients will be calling from our test process (from the host machine).</li></ol><p class="post-module__p___-9FAs">We can use this fixture in our test. Let's test that 3 step application flow we mentioned before.</p><pre class="prism-code language-csharp" style="color:#9cdcfe;background-color:#1e1e1e;padding:20px;border-radius:5px;overflow:auto"><div class="token-line" style="color:#9cdcfe"><span class="token keyword" style="color:#569cd6">using</span><span class="token plain"> </span><span class="token namespace">System</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Net</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Http</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Json</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">namespace</span><span class="token plain"> </span><span class="token namespace">EndToEndTests</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">class</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">FlowTest</span><span class="token plain"> </span><span class="token punctuation" style="color:#d4d4d4">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:#4ec9b0">IClassFixture</span><span class="token type-list class-name punctuation" style="color:#d4d4d4">&lt;</span><span class="token type-list class-name" style="color:#4ec9b0">AppFixture</span><span class="token type-list class-name punctuation" style="color:#d4d4d4">></span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">HttpClient</span><span class="token plain"> _calculatorClient</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">HttpClient</span><span class="token plain"> _historyClient</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token function" style="color:#dcdcaa">FlowTest</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token class-name" style="color:#4ec9b0">AppFixture</span><span class="token plain"> appFixture</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _calculatorClient </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> appFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">CalculatorClient</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _historyClient </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> appFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">HistoryClient</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">[</span><span class="token attribute class-name" style="color:#4ec9b0">Fact</span><span class="token punctuation" style="color:#d4d4d4">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#4ec9b0">Task</span><span class="token plain"> </span><span class="token function" style="color:#dcdcaa">CalculatorOperationsGetSavedToHistory</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token class-name keyword" style="color:#569cd6">var</span><span class="token plain"> a </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token number" style="color:#b5cea8">4</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token class-name keyword" style="color:#569cd6">var</span><span class="token plain"> b </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token number" style="color:#b5cea8">8</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token class-name keyword" style="color:#569cd6">var</span><span class="token plain"> additionResult </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> a </span><span class="token operator" style="color:#d4d4d4">+</span><span class="token plain"> b</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token class-name keyword" style="color:#569cd6">var</span><span class="token plain"> subractionResult </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> a </span><span class="token operator" style="color:#d4d4d4">-</span><span class="token plain"> b</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token class-name keyword" style="color:#569cd6">var</span><span class="token plain"> historyLog </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _historyClient</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token generic-method function" style="color:#dcdcaa">GetFromJsonAsync</span><span class="token generic-method generic class-name punctuation" style="color:#d4d4d4">&lt;</span><span class="token generic-method generic class-name" style="color:#4ec9b0">IEnumerable</span><span class="token generic-method generic class-name punctuation" style="color:#d4d4d4">&lt;</span><span class="token generic-method generic class-name" style="color:#4ec9b0">HistoryEntry</span><span class="token generic-method generic class-name punctuation" style="color:#d4d4d4">></span><span class="token generic-method generic class-name punctuation" style="color:#d4d4d4">></span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"history"</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        Assert</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">NotNull</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">historyLog</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        Assert</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">Empty</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">historyLog</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token class-name keyword" style="color:#569cd6">var</span><span class="token plain"> result </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _calculatorClient</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token generic-method function" style="color:#dcdcaa">GetFromJsonAsync</span><span class="token generic-method generic class-name punctuation" style="color:#d4d4d4">&lt;</span><span class="token generic-method generic class-name keyword" style="color:#569cd6">int</span><span class="token generic-method generic class-name punctuation" style="color:#d4d4d4">></span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token interpolation-string string" style="color:#ce9178">$"add?a=</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">{</span><span class="token interpolation-string interpolation expression language-csharp">a</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">}</span><span class="token interpolation-string string" style="color:#ce9178">&b=</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">{</span><span class="token interpolation-string interpolation expression language-csharp">b</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">}</span><span class="token interpolation-string string" style="color:#ce9178">"</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        Assert</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">Equal</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">additionResult</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        result </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _calculatorClient</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token generic-method function" style="color:#dcdcaa">GetFromJsonAsync</span><span class="token generic-method generic class-name punctuation" style="color:#d4d4d4">&lt;</span><span class="token generic-method generic class-name keyword" style="color:#569cd6">int</span><span class="token generic-method generic class-name punctuation" style="color:#d4d4d4">></span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token interpolation-string string" style="color:#ce9178">$"subtract?a=</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">{</span><span class="token interpolation-string interpolation expression language-csharp">a</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">}</span><span class="token interpolation-string string" style="color:#ce9178">&b=</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">{</span><span class="token interpolation-string interpolation expression language-csharp">b</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">}</span><span class="token interpolation-string string" style="color:#ce9178">"</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        Assert</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">Equal</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">subractionResult</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        historyLog </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _historyClient</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token generic-method function" style="color:#dcdcaa">GetFromJsonAsync</span><span class="token generic-method generic class-name punctuation" style="color:#d4d4d4">&lt;</span><span class="token generic-method generic class-name" style="color:#4ec9b0">IEnumerable</span><span class="token generic-method generic class-name punctuation" style="color:#d4d4d4">&lt;</span><span class="token generic-method generic class-name" style="color:#4ec9b0">HistoryEntry</span><span class="token generic-method generic class-name punctuation" style="color:#d4d4d4">></span><span class="token generic-method generic class-name punctuation" style="color:#d4d4d4">></span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"history"</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        Assert</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">NotNull</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">historyLog</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        Assert</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">Equal</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">HistoryEntry</span><span class="token constructor-invocation class-name punctuation" style="color:#d4d4d4">[</span><span class="token constructor-invocation class-name punctuation" style="color:#d4d4d4">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">HistoryEntry</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"add"</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"> additionResult</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">HistoryEntry</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"subtract"</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"> subractionResult</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token punctuation" style="color:#d4d4d4">}</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"> historyLog</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token punctuation" style="color:#d4d4d4">}</span></div></pre><p class="post-module__p___-9FAs">Passing the <code class="post-module__code___aFlPv">AppFixture</code> for the <code class="post-module__code___aFlPv">IClassFixture&lt;T></code>, xUnit will inject the <code class="post-module__code___aFlPv">AppFixture</code> into our test class constructor. The fixture at this point is already initialized (<code class="post-module__code___aFlPv">InitializedAsync</code> was called) and our containers should be running. We can see that all we need in the test from the fixture are the two clients to communicate with the APIs. The test code itself is pretty straightforward and readable so it's nice that we contained all of the Testcontainers setup behind the scenes in the fixture.</p><p class="post-module__p___-9FAs">This test should execute successfully. Make sure Docker is running (Testcontainers will try to connect to the locally running Docker host).</p><a href="#example-2" class="postSectionHeader-module__link___iC7QI"><img alt="Go to example-2" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBhcmlhLWhpZGRlbj0idHJ1ZSIgcm9sZT0iaW1nIiB3aWR0aD0iMWVtIiBoZWlnaHQ9IjFlbSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ieE1pZFlNaWQgbWVldCIgdmlld0JveD0iMCAwIDI0IDI0Ij48ZyBmaWxsPSJub25lIj48cGF0aCBkPSJNMTMuNTQ0IDEwLjQ1NmE0LjM2OCA0LjM2OCAwIDAgMC02LjE3NiAwbC0zLjA4OSAzLjA4OGE0LjM2NyA0LjM2NyAwIDEgMCA2LjE3NyA2LjE3N0wxMiAxOC4xNzciIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjxwYXRoIGQ9Ik0xMC40NTYgMTMuNTQ0YTQuMzY4IDQuMzY4IDAgMCAwIDYuMTc2IDBsMy4wODktMy4wODhhNC4zNjcgNC4zNjcgMCAxIDAtNi4xNzctNi4xNzdMMTIgNS44MjMiIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjwvZz48L3N2Zz4=" class="postSectionHeader-module__icon___jd0Dl" style="top:10px"><h2 id="example-2">Example 2</h2></a><p class="post-module__p___-9FAs"><em>The source code for this can be found on <a href="https://github.com/BenasB/dotnet-e2e-testcontainers/tree/main/ExampleTwo" class="post-module__link___nNizU" rel="noopener noreferrer" target="_blank">GitHub</a></em></p><p class="post-module__p___-9FAs">Let's tackle a more complex scenario. Alongside .NET services, we can add some infrastructure components. This scenario models a blogging application. Below is a diagram depicting the data flow in this scenario.</p><p class="post-module__p___-9FAs"><span class="lazy-load-image-background blur" style="width:100%"><span class="" style="display:block;margin:0 auto;max-width:100%"></span></span></p><ul class="post-module__list___kIKQ1"><li class="post-module__li___TFeQu">Blog is a Blazor Server service which displays the posts retrieved from Blog DB and also allows the users to fill in a newsletter form which saves their email to Newsletter DB.</li><li class="post-module__li___TFeQu">Blog Admin is a Blazor Server service which allows a user to fill in a form and create a new blog post which gets saved to the Blog DB and a message gets sent into the Blog Events queue.</li><li class="post-module__li___TFeQu">Notifier is a .NET worker service which, upon getting a message from the Blog Events queue, retrieves the blog post title from Blog DB, retrieves all subscribers from Newsletter DB and sends them an email informing them about the new blog post.</li></ul><p class="post-module__p___-9FAs">Similarly to Example 1, let's define an application flow that we want to test:</p><ol class="post-module__list___kIKQ1"><li class="post-module__li___TFeQu">User fills in the newsletter form in Blog</li><li class="post-module__li___TFeQu">User creates a new post in Blog Admin</li><li class="post-module__li___TFeQu">Check if the user received an email informing about the new post</li></ol><p class="post-module__p___-9FAs">As for the technologies we'll be using:</p><ul class="post-module__list___kIKQ1"><li class="post-module__li___TFeQu">MySQL with Entity Framework for the databases</li><li class="post-module__li___TFeQu"><a href="https://www.rabbitmq.com/" class="post-module__link___nNizU" rel="noopener noreferrer" target="_blank">RabbitMQ</a> for the queue</li><li class="post-module__li___TFeQu"><a href="https://github.com/mailhog/MailHog" class="post-module__link___nNizU" rel="noopener noreferrer" target="_blank">MailHog</a> for the SMTP server (it even comes with an API to easily retrieve sent emails)</li><li class="post-module__li___TFeQu"><a href="https://playwright.dev/dotnet/" class="post-module__link___nNizU" rel="noopener noreferrer" target="_blank">Playwright</a> to act as the user on Blog and Blog Admin</li></ul><p class="post-module__p___-9FAs">We can also visualize how the test should look from a network perspective again:</p><p class="post-module__p___-9FAs"><span class="lazy-load-image-background blur" style="width:100%"><span class="" style="display:block;margin:0 auto;max-width:100%"></span></span></p><p class="post-module__p___-9FAs">We can move on to the code. The approach is a bit different this time: every container will have a separate fixture and the <code class="post-module__code___aFlPv">AppFixture</code> will aggregate them.</p><p class="post-module__p___-9FAs">Let's take a look at some of the container fixture classes (you can inspect all of the fixtures in the source code on GitHub).</p><p class="post-module__p___-9FAs">The <code class="post-module__code___aFlPv">RabbitMqFixture</code> is responsible for the RabbitMQ container (duh). One new thing here is that we're using the RabbitMQ module provided by Testcontainers for .NET. The module does some pre-configuration for you, such as setting up port bindings (which we're not using, since we only need to communicate inside the Docker network), configuring the RabbitMQ host, supplying you the connection string, etc. We've created the <code class="post-module__code___aFlPv">InternalNetworkConnectionString</code> (using network alias) ourselves since we need it for container-to-container communication.</p><pre class="prism-code language-csharp" style="color:#9cdcfe;background-color:#1e1e1e;padding:20px;border-radius:5px;overflow:auto"><div class="token-line" style="color:#9cdcfe"><span class="token keyword" style="color:#569cd6">using</span><span class="token plain"> </span><span class="token namespace">DotNet</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Testcontainers</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Networks</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">using</span><span class="token plain"> </span><span class="token namespace">Testcontainers</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">RabbitMq</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">namespace</span><span class="token plain"> </span><span class="token namespace">EndToEndTests</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Fixtures</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">class</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">RabbitMqFixture</span><span class="token plain"> </span><span class="token punctuation" style="color:#d4d4d4">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:#4ec9b0">IAsyncLifetime</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">const</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#569cd6">int</span><span class="token plain"> InternalPort </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token number" style="color:#b5cea8">5672</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">const</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#569cd6">string</span><span class="token plain"> Username </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token string" style="color:#ce9178">"rabbitmq"</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">const</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#569cd6">string</span><span class="token plain"> Password </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token string" style="color:#ce9178">"rabbitmq"</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">RabbitMqContainer</span><span class="token plain"> _container</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#569cd6">string</span><span class="token plain"> InternalNetworkConnectionString </span><span class="token operator" style="color:#d4d4d4">=></span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token interpolation-string string" style="color:#ce9178">$"amqp://</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">{</span><span class="token interpolation-string interpolation expression language-csharp">Username</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">}</span><span class="token interpolation-string string" style="color:#ce9178">:</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">{</span><span class="token interpolation-string interpolation expression language-csharp">Password</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">}</span><span class="token interpolation-string string" style="color:#ce9178">@</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:#569cd6">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:#d4d4d4">(</span><span class="token interpolation-string interpolation expression language-csharp">RabbitMqFixture</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:#d4d4d4">)</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">}</span><span class="token interpolation-string string" style="color:#ce9178">:</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">{</span><span class="token interpolation-string interpolation expression language-csharp">InternalPort</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">}</span><span class="token interpolation-string string" style="color:#ce9178">"</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token function" style="color:#dcdcaa">RabbitMqFixture</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token class-name" style="color:#4ec9b0">INetwork</span><span class="token class-name punctuation" style="color:#d4d4d4">?</span><span class="token plain"> network</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _container </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">RabbitMqBuilder</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithNetwork</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">network</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithNetworkAliases</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token keyword" style="color:#569cd6">nameof</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">RabbitMqFixture</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithUsername</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">Username</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithPassword</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">Password</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">Build</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#4ec9b0">Task</span><span class="token plain"> </span><span class="token function" style="color:#dcdcaa">InitializeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"> </span><span class="token operator" style="color:#d4d4d4">=></span><span class="token plain"> _container</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">StartAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#4ec9b0">Task</span><span class="token plain"> </span><span class="token function" style="color:#dcdcaa">DisposeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"> </span><span class="token operator" style="color:#d4d4d4">=></span><span class="token plain"> _container</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">DisposeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">AsTask</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token punctuation" style="color:#d4d4d4">}</span></div></pre><p class="post-module__p___-9FAs">The <code class="post-module__code___aFlPv">MailFixture</code> is responsible for the MailHog container. There's no module for MailHog, so we'll need to manually specify the image. This is an interesting case since we will need both container-to-container communication (Notifier container will call this) and communication from the host machine as well (to assert we'll call the MailHog's API from the Test Process). For the former, we've created <code class="post-module__code___aFlPv">InternalNetworkConnectionString</code> (using network alias) and for the latter, we'll be using <code class="post-module__code___aFlPv">ApiConnectionString</code> (using hostname). Of course, because the API will be called from the host machine, we also need to create the port binding for the <code class="post-module__code___aFlPv">InternalApiPort</code>.</p><pre class="prism-code language-csharp" style="color:#9cdcfe;background-color:#1e1e1e;padding:20px;border-radius:5px;overflow:auto"><div class="token-line" style="color:#9cdcfe"><span class="token keyword" style="color:#569cd6">using</span><span class="token plain"> </span><span class="token namespace">DotNet</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Testcontainers</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Builders</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">using</span><span class="token plain"> </span><span class="token namespace">DotNet</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Testcontainers</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Containers</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">using</span><span class="token plain"> </span><span class="token namespace">DotNet</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Testcontainers</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Networks</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">namespace</span><span class="token plain"> </span><span class="token namespace">EndToEndTests</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Fixtures</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">class</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">MailFixture</span><span class="token plain"> </span><span class="token punctuation" style="color:#d4d4d4">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:#4ec9b0">IAsyncLifetime</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">const</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#569cd6">int</span><span class="token plain"> InternalSmtpPort </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token number" style="color:#b5cea8">1025</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">const</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#569cd6">int</span><span class="token plain"> InternalApiPort </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token number" style="color:#b5cea8">8025</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"> </span><span class="token comment" style="color:#6a9955">// MailHog also has an API to retrieve sent emails</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">IContainer</span><span class="token plain"> _container</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#569cd6">string</span><span class="token plain"> ApiConnectionString </span><span class="token operator" style="color:#d4d4d4">=></span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token interpolation-string string" style="color:#ce9178">$"http://</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">{</span><span class="token interpolation-string interpolation expression language-csharp">_container</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:#d4d4d4">.</span><span class="token interpolation-string interpolation expression language-csharp">Hostname</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">}</span><span class="token interpolation-string string" style="color:#ce9178">:</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">{</span><span class="token interpolation-string interpolation expression language-csharp">_container</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:#d4d4d4">.</span><span class="token interpolation-string interpolation expression language-csharp function" style="color:#dcdcaa">GetMappedPublicPort</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:#d4d4d4">(</span><span class="token interpolation-string interpolation expression language-csharp">InternalApiPort</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:#d4d4d4">)</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">}</span><span class="token interpolation-string string" style="color:#ce9178">"</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">static</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#569cd6">string</span><span class="token plain"> InternalNetworkConnectionString </span><span class="token operator" style="color:#d4d4d4">=></span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token interpolation-string string" style="color:#ce9178">$"smtp://</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">{</span><span class="token interpolation-string interpolation expression language-csharp keyword" style="color:#569cd6">nameof</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:#d4d4d4">(</span><span class="token interpolation-string interpolation expression language-csharp">MailFixture</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:#d4d4d4">)</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">}</span><span class="token interpolation-string string" style="color:#ce9178">:</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">{</span><span class="token interpolation-string interpolation expression language-csharp">InternalSmtpPort</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">}</span><span class="token interpolation-string string" style="color:#ce9178">"</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token function" style="color:#dcdcaa">MailFixture</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token class-name" style="color:#4ec9b0">INetwork</span><span class="token class-name punctuation" style="color:#d4d4d4">?</span><span class="token plain"> network</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _container </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">ContainerBuilder</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithImage</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"mailhog/mailhog:latest"</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithNetwork</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">network</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithNetworkAliases</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token keyword" style="color:#569cd6">nameof</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">MailFixture</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithPortBinding</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">InternalApiPort</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithWaitStrategy</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">Wait</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">ForUnixContainer</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">UntilPortIsAvailable</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">InternalSmtpPort</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithWaitStrategy</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">Wait</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">ForUnixContainer</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">UntilHttpRequestIsSucceeded</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">request </span><span class="token operator" style="color:#d4d4d4">=></span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">                request</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">ForPort</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">InternalApiPort</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">ForPath</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"/"</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">Build</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#4ec9b0">Task</span><span class="token plain"> </span><span class="token function" style="color:#dcdcaa">InitializeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"> </span><span class="token operator" style="color:#d4d4d4">=></span><span class="token plain"> _container</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">StartAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#4ec9b0">Task</span><span class="token plain"> </span><span class="token function" style="color:#dcdcaa">DisposeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"> </span><span class="token operator" style="color:#d4d4d4">=></span><span class="token plain"> _container</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">DisposeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">AsTask</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token punctuation" style="color:#d4d4d4">}</span></div></pre><p class="post-module__p___-9FAs">Last but not least, let's take a look at the <code class="post-module__code___aFlPv">BlogAdmin</code> fixture. We're building the image from a Dockerfile again. We let the Blog Admin know how to connect to RabbitMQ and MySQL using the internal network connection strings (using network aliases). We also add a port binding and create the <code class="post-module__code___aFlPv">ConnectionString</code> so that Playwright (which will be running on our host machine) can call the Blog Admin.</p><pre class="prism-code language-csharp" style="color:#9cdcfe;background-color:#1e1e1e;padding:20px;border-radius:5px;overflow:auto"><div class="token-line" style="color:#9cdcfe"><span class="token keyword" style="color:#569cd6">using</span><span class="token plain"> </span><span class="token namespace">DotNet</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Testcontainers</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Builders</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">using</span><span class="token plain"> </span><span class="token namespace">DotNet</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Testcontainers</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Containers</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">using</span><span class="token plain"> </span><span class="token namespace">DotNet</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Testcontainers</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Images</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">using</span><span class="token plain"> </span><span class="token namespace">DotNet</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Testcontainers</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Networks</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">namespace</span><span class="token plain"> </span><span class="token namespace">EndToEndTests</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Fixtures</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">class</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">BlogAdminFixture</span><span class="token plain"> </span><span class="token punctuation" style="color:#d4d4d4">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:#4ec9b0">IAsyncLifetime</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">const</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#569cd6">int</span><span class="token plain"> InternalPort </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token number" style="color:#b5cea8">80</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">IFutureDockerImage</span><span class="token plain"> _image</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">IContainer</span><span class="token plain"> _container</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token return-type class-name keyword" style="color:#569cd6">string</span><span class="token plain"> ConnectionString </span><span class="token operator" style="color:#d4d4d4">=></span><span class="token plain"> </span><span class="token interpolation-string string" style="color:#ce9178">$"http://</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">{</span><span class="token interpolation-string interpolation expression language-csharp">_container</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:#d4d4d4">.</span><span class="token interpolation-string interpolation expression language-csharp">Hostname</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">}</span><span class="token interpolation-string string" style="color:#ce9178">:</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">{</span><span class="token interpolation-string interpolation expression language-csharp">_container</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:#d4d4d4">.</span><span class="token interpolation-string interpolation expression language-csharp function" style="color:#dcdcaa">GetMappedPublicPort</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:#d4d4d4">(</span><span class="token interpolation-string interpolation expression language-csharp">InternalPort</span><span class="token interpolation-string interpolation expression language-csharp punctuation" style="color:#d4d4d4">)</span><span class="token interpolation-string interpolation punctuation" style="color:#d4d4d4">}</span><span class="token interpolation-string string" style="color:#ce9178">"</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token function" style="color:#dcdcaa">BlogAdminFixture</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token class-name" style="color:#4ec9b0">INetwork</span><span class="token class-name punctuation" style="color:#d4d4d4">?</span><span class="token plain"> network</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _image </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">ImageFromDockerfileBuilder</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithDockerfileDirectory</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">CommonDirectoryPath</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">GetSolutionDirectory</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">DirectoryPath</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithDockerfile</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"Dockerfile.BlogAdmin"</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithBuildArgument</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"RESOURCE_REAPER_SESSION_ID"</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"> ResourceReaper</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">DefaultSessionId</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">ToString</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"D"</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">Build</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _container </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">ContainerBuilder</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithImage</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">_image</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithNetwork</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">network</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithNetworkAliases</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token keyword" style="color:#569cd6">nameof</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">BlogAdminFixture</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithPortBinding</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">InternalPort</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithEnvironment</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"ConnectionStrings__RabbitUri"</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"> RabbitMqFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">InternalNetworkConnectionString</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithEnvironment</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"ConnectionStrings__BlogDatabase"</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"> MySqlFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">BlogInternalNetworkConnectionString</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WithWaitStrategy</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">Wait</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">ForUnixContainer</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">UntilHttpRequestIsSucceeded</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">request </span><span class="token operator" style="color:#d4d4d4">=></span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">                request</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">ForPort</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">InternalPort</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">ForPath</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"/"</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">Build</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#4ec9b0">Task</span><span class="token plain"> </span><span class="token function" style="color:#dcdcaa">InitializeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _image</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">CreateAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _container</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">StartAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#4ec9b0">Task</span><span class="token plain"> </span><span class="token function" style="color:#dcdcaa">DisposeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"> </span><span class="token operator" style="color:#d4d4d4">=></span><span class="token plain"> _container</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">DisposeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">AsTask</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token punctuation" style="color:#d4d4d4">}</span></div></pre><p class="post-module__p___-9FAs">As mentioned before, <code class="post-module__code___aFlPv">AppFixture</code> aggregates all of these container fixtures.</p><pre class="prism-code language-csharp" style="color:#9cdcfe;background-color:#1e1e1e;padding:20px;border-radius:5px;overflow:auto"><div class="token-line" style="color:#9cdcfe"><span class="token keyword" style="color:#569cd6">using</span><span class="token plain"> </span><span class="token namespace">DataAccess</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">using</span><span class="token plain"> </span><span class="token namespace">DotNet</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Testcontainers</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Builders</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">using</span><span class="token plain"> </span><span class="token namespace">DotNet</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Testcontainers</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Networks</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">using</span><span class="token plain"> </span><span class="token namespace">Microsoft</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">EntityFrameworkCore</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">using</span><span class="token plain"> </span><span class="token namespace">Microsoft</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Playwright</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">namespace</span><span class="token plain"> </span><span class="token namespace">EndToEndTests</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Fixtures</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">class</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">AppFixture</span><span class="token plain"> </span><span class="token punctuation" style="color:#d4d4d4">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:#4ec9b0">IAsyncLifetime</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">INetwork</span><span class="token plain"> _network</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">PlaywrightFixture</span><span class="token plain"> _playwrightFixture</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">MySqlFixture</span><span class="token plain"> _mySqlFixture</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">RabbitMqFixture</span><span class="token plain"> _rabbitMqFixture</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">MailFixture</span><span class="token plain"> _mailFixture</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">BlogFixture</span><span class="token plain"> _blogFixture</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">BlogAdminFixture</span><span class="token plain"> _blogAdminFixture</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">NotifierFixture</span><span class="token plain"> _notifierFixture</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">IPage</span><span class="token class-name punctuation" style="color:#d4d4d4">?</span><span class="token plain"> _blogPage</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">IPage</span><span class="token class-name punctuation" style="color:#d4d4d4">?</span><span class="token plain"> _blogAdminPage</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">MailClient</span><span class="token class-name punctuation" style="color:#d4d4d4">?</span><span class="token plain"> _mailClient</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#4ec9b0">IPage</span><span class="token plain"> BlogPage </span><span class="token operator" style="color:#d4d4d4">=></span><span class="token plain"> _blogPage </span><span class="token operator" style="color:#d4d4d4">??</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">InvalidOperationException</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"Blog page is not initialized yet"</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#4ec9b0">IPage</span><span class="token plain"> BlogAdminPage </span><span class="token operator" style="color:#d4d4d4">=></span><span class="token plain"> _blogAdminPage </span><span class="token operator" style="color:#d4d4d4">??</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">InvalidOperationException</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"BlogAdmin page is not initialized yet"</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#4ec9b0">MailClient</span><span class="token plain"> MailClient </span><span class="token operator" style="color:#d4d4d4">=></span><span class="token plain"> _mailClient </span><span class="token operator" style="color:#d4d4d4">??</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">throw</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">InvalidOperationException</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"MailClient is not initialized yet"</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token function" style="color:#dcdcaa">AppFixture</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _network </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">NetworkBuilder</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">          </span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">Build</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _playwrightFixture </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">PlaywrightFixture</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _mySqlFixture </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">MySqlFixture</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">_network</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _rabbitMqFixture </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">RabbitMqFixture</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">_network</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _mailFixture </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">MailFixture</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">_network</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _blogFixture </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">BlogFixture</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">_network</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _blogAdminFixture </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">BlogAdminFixture</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">_network</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _notifierFixture </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">NotifierFixture</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">_network</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#4ec9b0">Task</span><span class="token plain"> </span><span class="token function" style="color:#dcdcaa">InitializeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _playwrightFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">InitializeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _network</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">CreateAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token comment" style="color:#6a9955">// Start up infrastructure</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> Task</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WhenAll</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            _mySqlFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">InitializeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            _rabbitMqFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">InitializeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            _mailFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">InitializeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> </span><span class="token function" style="color:#dcdcaa">InitializeDbSchema</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _mailClient </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">MailClient</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">Uri</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">_mailFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">ApiConnectionString</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token comment" style="color:#6a9955">// Start up applications</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> Task</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WhenAll</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            _blogFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">InitializeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            _blogAdminFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">InitializeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            _notifierFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">InitializeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _blogPage </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _playwrightFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">Browser</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">NewPageAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _blogPage</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">GotoAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">_blogFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">ConnectionString</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _blogAdminPage </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _playwrightFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">Browser</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">NewPageAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _blogAdminPage</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">GotoAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">_blogAdminFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">ConnectionString</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#4ec9b0">Task</span><span class="token plain"> </span><span class="token function" style="color:#dcdcaa">DisposeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _playwrightFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">DisposeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> Task</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WhenAll</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            _blogFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">DisposeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            _blogAdminFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">DisposeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            _notifierFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">DisposeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _mailClient</span><span class="token punctuation" style="color:#d4d4d4">?.</span><span class="token function" style="color:#dcdcaa">Dispose</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> Task</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WhenAll</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            _mySqlFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">DisposeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            _rabbitMqFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">DisposeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            _mailFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">DisposeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _network</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">DisposeAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#4ec9b0">Task</span><span class="token plain"> </span><span class="token function" style="color:#dcdcaa">InitializeDbSchema</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token class-name keyword" style="color:#569cd6">var</span><span class="token plain"> blogContextOptions </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">DbContextOptionsBuilder</span><span class="token constructor-invocation class-name punctuation" style="color:#d4d4d4">&lt;</span><span class="token constructor-invocation class-name" style="color:#4ec9b0">BlogContext</span><span class="token constructor-invocation class-name punctuation" style="color:#d4d4d4">></span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">UseMySql</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            _mySqlFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">BlogConnectionString</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            ServerVersion</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">AutoDetect</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">_mySqlFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">BlogConnectionString</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">Options</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token class-name keyword" style="color:#569cd6">var</span><span class="token plain"> newsletterContextOptions </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">DbContextOptionsBuilder</span><span class="token constructor-invocation class-name punctuation" style="color:#d4d4d4">&lt;</span><span class="token constructor-invocation class-name" style="color:#4ec9b0">NewsletterContext</span><span class="token constructor-invocation class-name punctuation" style="color:#d4d4d4">></span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">UseMySql</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            _mySqlFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">NewsletterConnectionString</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            ServerVersion</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">AutoDetect</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">_mySqlFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">NewsletterConnectionString</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">Options</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">using</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#569cd6">var</span><span class="token plain"> newsletterContext </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">NewsletterContext</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">newsletterContextOptions</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">using</span><span class="token plain"> </span><span class="token class-name keyword" style="color:#569cd6">var</span><span class="token plain"> blogContext </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token plain"> </span><span class="token constructor-invocation class-name" style="color:#4ec9b0">BlogContext</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">blogContextOptions</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> Task</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">WhenAll</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            newsletterContext</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">Database</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">EnsureCreatedAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            blogContext</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">Database</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">EnsureCreatedAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token punctuation" style="color:#d4d4d4">}</span></div></pre><p class="post-module__p___-9FAs">The <code class="post-module__code___aFlPv">AppFixture</code> supplies our test code with two Playwright's <code class="post-module__code___aFlPv">IPage</code>s for Blog and Blog Admin and a <code class="post-module__code___aFlPv">MailClient</code> to retrieve the sent emails from MailHog. Let's see how to test out the application flow we described earlier.</p><pre class="prism-code language-csharp" style="color:#9cdcfe;background-color:#1e1e1e;padding:20px;border-radius:5px;overflow:auto"><div class="token-line" style="color:#9cdcfe"><span class="token keyword" style="color:#569cd6">using</span><span class="token plain"> </span><span class="token namespace">EndToEndTests</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Fixtures</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">using</span><span class="token plain"> </span><span class="token namespace">Microsoft</span><span class="token namespace punctuation" style="color:#d4d4d4">.</span><span class="token namespace">Playwright</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">namespace</span><span class="token plain"> </span><span class="token namespace">EndToEndTests</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">class</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">FlowTest</span><span class="token punctuation" style="color:#d4d4d4">:</span><span class="token plain"> </span><span class="token type-list class-name" style="color:#4ec9b0">IClassFixture</span><span class="token type-list class-name punctuation" style="color:#d4d4d4">&lt;</span><span class="token type-list class-name" style="color:#4ec9b0">AppFixture</span><span class="token type-list class-name punctuation" style="color:#d4d4d4">></span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">IPage</span><span class="token plain"> _blogPage</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">IPage</span><span class="token plain"> _blogAdminPage</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">private</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">readonly</span><span class="token plain"> </span><span class="token class-name" style="color:#4ec9b0">MailClient</span><span class="token plain"> _mailClient</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token function" style="color:#dcdcaa">FlowTest</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token class-name" style="color:#4ec9b0">AppFixture</span><span class="token plain"> appFixture</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _blogPage </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> appFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">BlogPage</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _blogAdminPage </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> appFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">BlogAdminPage</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        _mailClient </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> appFixture</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">MailClient</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">[</span><span class="token attribute class-name" style="color:#4ec9b0">Fact</span><span class="token punctuation" style="color:#d4d4d4">]</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token keyword" style="color:#569cd6">public</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">async</span><span class="token plain"> </span><span class="token return-type class-name" style="color:#4ec9b0">Task</span><span class="token plain"> </span><span class="token function" style="color:#dcdcaa">EmailIsSentWhenNewPostIsCreated</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token class-name keyword" style="color:#569cd6">var</span><span class="token plain"> email </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token string" style="color:#ce9178">"test@benasb.github.io"</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _blogPage</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">GetByPlaceholder</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"Email"</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">FillAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">email</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _blogPage</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">GetByRole</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">AriaRole</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">Button</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            Name </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token string" style="color:#ce9178">"Subscribe"</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            Exact </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token punctuation" style="color:#d4d4d4">}</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">ClickAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token class-name keyword" style="color:#569cd6">var</span><span class="token plain"> newPostTitle </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token string" style="color:#ce9178">"Immaculate new post"</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _blogAdminPage</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">GetByPlaceholder</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"Title"</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">FillAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">newPostTitle</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _blogAdminPage</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">GetByPlaceholder</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"Body"</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">FillAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token string" style="color:#ce9178">"Lorem ipsum"</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _blogAdminPage</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">GetByRole</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">AriaRole</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">Button</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">new</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token punctuation" style="color:#d4d4d4">{</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            Name </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token string" style="color:#ce9178">"Create"</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">            Exact </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token punctuation" style="color:#d4d4d4">}</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">ClickAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token comment" style="color:#6a9955">// Give some time for the message to be consumed and email sent</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> Task</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">Delay</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">TimeSpan</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">FromSeconds</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token number" style="color:#b5cea8">2</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token class-name keyword" style="color:#569cd6">var</span><span class="token plain"> allMessagesResponse </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> </span><span class="token keyword" style="color:#569cd6">await</span><span class="token plain"> _mailClient</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">GetAllMessagesAsync</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        Assert</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">NotNull</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">allMessagesResponse</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token class-name keyword" style="color:#569cd6">var</span><span class="token plain"> sentEmailContent </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> Assert</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">Single</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">allMessagesResponse</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">Items</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">Content</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        Assert</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">Contains</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">newPostTitle</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"> sentEmailContent</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">Body</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        </span><span class="token class-name keyword" style="color:#569cd6">var</span><span class="token plain"> toHeader </span><span class="token operator" style="color:#d4d4d4">=</span><span class="token plain"> Assert</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">Single</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">sentEmailContent</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">Headers</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token plain">To</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">        Assert</span><span class="token punctuation" style="color:#d4d4d4">.</span><span class="token function" style="color:#dcdcaa">Equal</span><span class="token punctuation" style="color:#d4d4d4">(</span><span class="token plain">email</span><span class="token punctuation" style="color:#d4d4d4">,</span><span class="token plain"> toHeader</span><span class="token punctuation" style="color:#d4d4d4">)</span><span class="token punctuation" style="color:#d4d4d4">;</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain">    </span><span class="token punctuation" style="color:#d4d4d4">}</span><span class="token plain"></span></div><div class="token-line" style="color:#9cdcfe"><span class="token plain"></span><span class="token punctuation" style="color:#d4d4d4">}</span></div></pre><p class="post-module__p___-9FAs">Again, we can see that the test code itself is pretty straightforward and all of the Testcontainers setup is left to the <code class="post-module__code___aFlPv">AppFixture</code> which allows you to not mix your test logic with the setup.</p><p class="post-module__p___-9FAs">Of course, this test should execute successfully. Make sure Docker is running (Testcontainers will try to connect to the locally running Docker host).</p><a href="#ci" class="postSectionHeader-module__link___iC7QI"><img alt="Go to ci" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBhcmlhLWhpZGRlbj0idHJ1ZSIgcm9sZT0iaW1nIiB3aWR0aD0iMWVtIiBoZWlnaHQ9IjFlbSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ieE1pZFlNaWQgbWVldCIgdmlld0JveD0iMCAwIDI0IDI0Ij48ZyBmaWxsPSJub25lIj48cGF0aCBkPSJNMTMuNTQ0IDEwLjQ1NmE0LjM2OCA0LjM2OCAwIDAgMC02LjE3NiAwbC0zLjA4OSAzLjA4OGE0LjM2NyA0LjM2NyAwIDEgMCA2LjE3NyA2LjE3N0wxMiAxOC4xNzciIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjxwYXRoIGQ9Ik0xMC40NTYgMTMuNTQ0YTQuMzY4IDQuMzY4IDAgMCAwIDYuMTc2IDBsMy4wODktMy4wODhhNC4zNjcgNC4zNjcgMCAxIDAtNi4xNzctNi4xNzdMMTIgNS44MjMiIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjwvZz48L3N2Zz4=" class="postSectionHeader-module__icon___jd0Dl" style="top:10px"><h2 id="ci">CI</h2></a><p class="post-module__p___-9FAs">Ideally, we want to run these kinds of tests during our Continuous Integration process. This is of course possible and pretty easy with GitHub Actions. Check out the <a href="https://github.com/BenasB/dotnet-e2e-testcontainers/blob/main/.github/workflows/dotnet.yml" class="post-module__link___nNizU" rel="noopener noreferrer" target="_blank">YAML file</a> in the example repository. For other providers there may be additional setup required, please refer to <a href="https://dotnet.testcontainers.org/cicd/" class="post-module__link___nNizU" rel="noopener noreferrer" target="_blank">Testcontainers for .NET</a>.</p><p class="post-module__p___-9FAs"><span class="lazy-load-image-background blur" style="width:100%"><span class="" style="display:block;margin:0 auto;max-width:100%"></span></span></p><a href="#conclusion" class="postSectionHeader-module__link___iC7QI"><img alt="Go to conclusion" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBhcmlhLWhpZGRlbj0idHJ1ZSIgcm9sZT0iaW1nIiB3aWR0aD0iMWVtIiBoZWlnaHQ9IjFlbSIgcHJlc2VydmVBc3BlY3RSYXRpbz0ieE1pZFlNaWQgbWVldCIgdmlld0JveD0iMCAwIDI0IDI0Ij48ZyBmaWxsPSJub25lIj48cGF0aCBkPSJNMTMuNTQ0IDEwLjQ1NmE0LjM2OCA0LjM2OCAwIDAgMC02LjE3NiAwbC0zLjA4OSAzLjA4OGE0LjM2NyA0LjM2NyAwIDEgMCA2LjE3NyA2LjE3N0wxMiAxOC4xNzciIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjxwYXRoIGQ9Ik0xMC40NTYgMTMuNTQ0YTQuMzY4IDQuMzY4IDAgMCAwIDYuMTc2IDBsMy4wODktMy4wODhhNC4zNjcgNC4zNjcgMCAxIDAtNi4xNzctNi4xNzdMMTIgNS44MjMiIHN0cm9rZT0iY3VycmVudENvbG9yIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIvPjwvZz48L3N2Zz4=" class="postSectionHeader-module__icon___jd0Dl" style="top:10px"><h2 id="conclusion">Conclusion</h2></a><p class="post-module__p___-9FAs">This post covers quite a lot: Testcontainers, Docker networking, xUnit, so I encourage you to try it out practically yourself and play around. Hopefully the gained knowledge will make your end-to-end testing strategy more reliable and convenient.</p></div></article></div></div></div></div></body></html>